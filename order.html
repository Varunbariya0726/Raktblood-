<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Page</title>
  <link rel="stylesheet" href="order.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .order-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      display: inline-block;
    }
    .status-pending {
      background-color: #ffc107;
      color: #000;
    }
    .status-processing {
      background-color: #2196F3;
      color: white;
    }
    .status-completed {
      background-color: #4CAF50;
      color: white;
    }
    .status-cancelled {
      background-color: #f44336;
      color: white;
    }
    .request-info {
      margin: 10px 0;
    }
    .request-info span {
      font-weight: bold;
    }
    .no-requests {
      text-align: center;
      padding: 20px;
      color: #666;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .track-btn {
      background-color: #d32f2f;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
    }
    .track-btn:hover {
      background-color: #b71c1c;
    }
    .close-track-btn {
      background-color: #666;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      margin-left: 10px;
      display: none;
    }
    .close-track-btn.visible {
      display: inline-block;
    }
    .track-orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .track-orders-section {
      display: none;
    }
    .track-orders-section.visible {
      display: block;
    }
    .order-date {
      color: #666;
      font-size: 0.9em;
      margin-top: 10px;
    }
    .approval-date {
      color: #4CAF50;
      font-size: 0.9em;
      margin-top: 5px;
      font-weight: bold;
    }
    .order-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .approved-bank {
      background-color: #e6f2ff;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      border-left: 4px solid #4CAF50;
    }
    .approved-bank h4 {
      color: #4CAF50;
      margin: 0 0 10px 0;
    }
    .approved-bank p {
      margin: 5px 0;
      color: #333;
    }
    .approved-bank .bank-contact {
      color: #2196F3;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="nav2">
    <a href="./home.html">HOME</a>
    <a href="./login.html">LOG OUT</a>
    
  </div>

  <div class="order-container">
    <h2>Need Blood?</h2>
    <p>Click below to request your Blood.</p>
    <button onclick="window.location.href='blood-order.html'" class="get-blood-btn">Get Blood Now</button>
     
  </div>

  <div class="order-form-container" style="display: none;">
    <h2>Order Form</h2>
    <form onsubmit="return submitOrder(event)">
      <input type="text" placeholder="Full Name" id="name" required />
      <input type="text" placeholder="Age" id="age" required oninput="this.value=this.value.replace(/[^0-9]/g, '')"/>
      <select id="blood" required>
        <option value="">Select Blood Group</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
      </select>
      <input type="text" placeholder="Location" id="location" required />
      <button type="submit">Submit Request</button>
    </form>
  </div>
  
  <div class="container">
    <div class="track-orders-header">
      <h2>Your Orders</h2>
      <div>
        <button class="track-btn" onclick="loadOrders()">Track Orders</button>
        <button class="close-track-btn" onclick="closeTrackOrders()">Close</button>
      </div>
    </div>
    <div id="orders-container" class="track-orders-section">
      <!-- Orders will be loaded here -->
    </div>
  </div>

  <script>
    function closeOrder() {
      // Optionally clear login flag
      window.location.href = "login.html";
    }

    function submitOrder(event) {
      event.preventDefault();
      alert("Blood request submitted successfully!");
      document.querySelector('.order-form-container').style.display = 'none';
    }

    // Prevent access if not logged in
    window.onload = () => {
      const storedUser = JSON.parse(localStorage.getItem("user"));
      if (!storedUser) {
        localStorage.setItem("returnToOrder", "true");
        window.location.href = "login.html";
      }
    };

    let allOrders = [];

    // Function to display orders
    function displayOrders(orders) {
      const container = document.getElementById('orders-container');
      container.innerHTML = '';

      if (!orders || orders.length === 0) {
        container.innerHTML = '<p class="no-requests">No orders found. You can make a new request  <a href="./blood-order.html">GET BLOOD NOW</a> .</p>';
        return;
      }

      // Sort orders by date (newest first)
      orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        const statusClass = `status-${order.status.toLowerCase()}`;
        const date = new Date(order.createdAt);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        
        // Get approval date if available
        const approvalDate = order.updatedAt ? 
          new Date(order.updatedAt).toLocaleDateString() + ' ' + new Date(order.updatedAt).toLocaleTimeString() : 
          'Not available';
        
        card.innerHTML = `
          <div class="order-status">
            <h3>Order #${order._id}</h3>
            <p><span>Status:</span> <span class="status ${order.status === 'Completed' ? 'status-approved' : order.status === 'Cancelled' ? 'status-rejected' : `status-${order.status.toLowerCase()}`}">${order.status === 'Completed' ? 'Approved' : order.status === 'Cancelled' ? 'Rejected' : order.status}</span></p>
          </div>
          <div class="request-info">
            <p><span>Patient Name:</span> ${order.patient.name}</p>
            <p><span>Age:</span> ${order.patient.age}</p>
            <p><span>Contact:</span> ${order.patient.contact}</p>
            <p><span>Address:</span> ${order.patient.address}</p>
            <p><span>Blood Group:</span> ${order.bloodDetails.group}</p>
            <p><span>Component:</span> ${order.bloodDetails.component}</p>
            <p><span>Hospital:</span> ${order.hospital.name}</p>
            <p><span>Doctor:</span> ${order.hospital.doctor}</p>
            <p><span>Ward:</span> ${order.hospital.ward}</p>
            <p><span>Payment Method:</span> ${order.paymentMethod}</p>
            <p><span>Payment Status:</span> ${order.paymentStatus ? 'Paid' : 'Unpaid'}</p>
          </div>
          ${order.status === 'Completed' ? `
            <div class="approved-bank">
              <h4>âœ… Approved Blood Bank</h4>
              ${order.approvedBloodBank ? `
                <p><span>Name:</span> ${order.approvedBloodBank.name}</p>
                <p><span>Address:</span> ${order.approvedBloodBank.address}</p>
                <p class="bank-contact"><span>Contact:</span> ${order.approvedBloodBank.contact}</p>
              ` : `
                <p><span>Blood Bank:</span> Information not available</p>
              `}
              <p><span>Approval Date:</span> ${approvalDate}</p>
            </div>
          ` : ''}
          <div class="order-date">
            Requested on: ${formattedDate}
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // Function to load and display orders
    async function loadOrders() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.error('No token found in localStorage');
          window.location.href = 'login.html';
          return;
        }

        console.log('Fetching orders with token...');
        
        const response = await fetch('http://localhost:3000/api/orders', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('Error response:', errorData);
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Received orders:', data);
        
        if (!Array.isArray(data)) {
          console.error('Invalid response format:', data);
          throw new Error('Invalid response format: expected array of orders');
        }
        
        allOrders = data;
        console.log('Number of orders found:', allOrders.length);
        displayOrders(allOrders);
        
        // Show the orders container and close button
        document.getElementById('orders-container').classList.add('visible');
        document.querySelector('.close-track-btn').classList.add('visible');
      } catch (error) {
        console.error('Error loading orders:', error);
        const container = document.getElementById('orders-container');
        container.innerHTML = `<p class="no-requests">Error loading orders: ${error.message}</p>`;
        container.classList.add('visible');
        document.querySelector('.close-track-btn').classList.add('visible');
      }
    }

    // Function to close tracked orders
    function closeTrackOrders() {
      const container = document.getElementById('orders-container');
      container.classList.remove('visible');
      container.innerHTML = ''; // Clear the content
      document.querySelector('.close-track-btn').classList.remove('visible');
    }
  </script>
</body>
</html>
